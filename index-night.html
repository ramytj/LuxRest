<!-- index_with_daynight_gauge.html -->
<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=0.4, minimum-scale=0.2, maximum-scale=3, user-scalable=yes">
  <title>Live Melanopic Lux Dashboard (Day/Night Gauge)</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <script>
    let parsedData = [];
    const csvUrl = "YOUR_CSV_URL_HERE"; // Use your URL
  </script>

  <style>
    /* Your original style unchanged */
  </style>
</head>

<body>
  <div id="dashboard-area">
    <div id="dashboard-window">
      <div id="dashboard-header">Melanopic Lux Dashboard</div>
      <div id="controls">
        <label for="date-select">Select Date:</label>
        <select id="date-select"></select>
        <label for="resolution-select">Resolution:</label>
        <select id="resolution-select">
          <option value="5">Every 5 min</option>
          <option value="15">Every 15 min</option>
          <option value="60" selected>Hourly</option>
          <option value="360">Every 6 hrs</option>
        </select>
      </div>
      <div id="chart-container">
        <div id="chart"></div>
        <div id="error-msg"></div>
      </div>
    </div>
  </div>

<script>
  /* === YOUR dragElement() EXACTLY AS IS === */
  const dragElement = (element, header) => {
    const gridSize = 100;
    let offsetX = 0, offsetY = 0, isDragging = false;
    header.onpointerdown = (e) => {
      e.preventDefault();
      isDragging = true;
      offsetX = e.clientX - element.offsetLeft;
      offsetY = e.clientY - element.offsetTop;
      document.onpointermove = (e) => {
        if (!isDragging) return;
        const newLeft = Math.round((e.clientX - offsetX) / gridSize) * gridSize;
        const newTop = Math.round((e.clientY - offsetY) / gridSize) * gridSize;
        const area = document.getElementById("dashboard-area");
        const maxX = area.offsetWidth - element.offsetWidth;
        const maxY = area.offsetHeight - element.offsetHeight;
        element.style.left = `${Math.max(0, Math.min(newLeft, maxX))}px`;
        element.style.top = `${Math.max(0, Math.min(newTop, maxY))}px`;
      };
      document.onpointerup = () => { isDragging = false; document.onpointermove = null; };
    };
  };
  dragElement(document.getElementById("dashboard-window"), document.getElementById("dashboard-header"));

  /* === YOUR FULL groupByResolution(), updateChart(), idealX/Y, all traces, layout === */

  function groupByResolution(data, resolutionMinutes) { /* same as yours */ }
  function updateChart(date, resolution) { /* your full version */ }
  function populateControls() { /* your full version */ }

</script>

<script>
  // === GAUGE ===
  const gaugeWindow = document.createElement("div");
  gaugeWindow.id = "gauge-window";
  gaugeWindow.style.cssText = `position: absolute; top: 100px; left: 100px; width: 600px; height: 400px; background: #fff; border-radius: 10px; box-shadow: 0 10px 20px rgba(0,0,0,0.2); z-index: 1001;`;
  gaugeWindow.innerHTML = `<div id="gauge-header" style="background: #FD5901; color: white; padding: 8px; font-weight: bold; border-top-left-radius: 10px; border-top-right-radius: 10px; cursor: move;">Exposure Quality (Last 3 hrs)</div><div id="gauge-chart" style="width: 100%; height: calc(100% - 40px);"></div>`;
  document.getElementById("dashboard-area").appendChild(gaugeWindow);
  dragElement(gaugeWindow, document.getElementById("gauge-header"));

  function drawLiveGauge() {
    const now = new Date();
    const isDay = now.getHours() >= 6 && now.getHours() < 18;

    const range = isDay ? [0, 1000] : [0, 200];
    const tickvals = isDay ? [0, 150, 250, 500, 1000] : [0, 1, 10, 50, 200];
    const steps = isDay
      ? [{ range: [0, 150], color: "#FD5901" }, { range: [150, 250], color: "#FAAB36" }, { range: [250, 1000], color: "#8FD694" }]
      : [{ range: [0, 1], color: "#006400" }, { range: [1, 10], color: "#00cc00" }, { range: [10, 50], color: "#FFD700" }, { range: [50, 200], color: "#FF0000" }];

    const recentData = parsedData.filter(d => d.datetime >= new Date(now.getTime() - 3*60*60*1000));
    const avgMel = recentData.length ? recentData.reduce((s, d) => s + d.mel, 0) / recentData.length : 0;

    Plotly.react("gauge-chart", [{
      type: "indicator",
      mode: "gauge+number",
      value: avgMel,
      title: { text: "Melanopic Lux (Last 3 hrs)" },
      gauge: { axis: { range: range, tickvals: tickvals }, bar: { color: "#888" }, steps: steps, shape: "angular" }
    }], { margin: { t: 50, b: 0 }, paper_bgcolor: "#fff", height: 260 }, { displayModeBar: false });
  }

  Papa.parse(csvUrl, {
    download: true, header: true, skipEmptyLines: true,
    complete: function(results) {
      parsedData = results.data.map(row => {
        const ts = parseInt(row['timestamp'] || '');
        const mel = parseFloat(row['mel'] || '');
        if (isNaN(ts) || isNaN(mel)) return null;
        const local = new Date(ts * 1000);
        return { datetime: local, dateStr: local.toISOString().split('T')[0], mel: mel };
      }).filter(r => r !== null);

      populateControls();
      drawLiveGauge();
      setInterval(drawLiveGauge, 60000);
    }
  });
</script>

</body>
</html>
