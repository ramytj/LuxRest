
<!DOCTYPE html>
<html>
<head>
  <title>Live Melanopic Lux Dashboard (Cache-Busting Enabled)</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #005F60; /* deep teal */
      margin: 0;
      height: 100vh;
    }
    #dashboard-window {
      width: 800px;
      height: 800px;
      border: 1px solid #ccc;
      border-radius: 10px;
      position: absolute;
      top: 100px;
      left: 100px;
      background: #FAAB36;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      z-index: 1000;
      overflow: auto;
      resize: both;
    }
    #dashboard-header {
      padding: 10px;
      background-color: #FD5901; /* strong orange */
      color: white;
      cursor: move;
      font-weight: bold;
      border-top-left-radius: 10px;
      border-top-right-radius: 10px;
    }
    #controls {
      margin: 10px;
    }
    select {
      padding: 5px 10px;
      margin-right: 10px;
    }
    #chart-container {
      background: #249EA0; /*light teal*/
      background-color: #FAAB36;
      border: 1px solid #F78104;
      border-radius: 5px;
      color: #000;
      font-weight: bold;
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
    }
    select:hover {
      background-color: #F78104;
      cursor: pointer;
    }
    select:focus {
      outline: none;
      box-shadow: 0 0 0 2px rgba(253, 89, 1, 0.4);
    }
    #chart {
      width: 100%;
      height: 650px;
    }
    #error-msg {
      color: red;
      padding: 0 20px 20px 20px;
    }
    
    select {
      padding: 6px 12px;
      background-color: #FAAB36;  /* soft orange */
      border: 1px solid #F78104;  /* deeper orange border */
      border-radius: 5px;
      color: #000;                /* dark text for contrast */
      font-weight: bold;
    }
    
    select {
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
    }
    #dashboard-window {
      transition: transform 0.2s ease;
    }
    #dashboard-window:active {
      transform: scale(1.01);
    }


  </style>
</head>
<body>
  <div id="dashboard-window">
    <div id="dashboard-header">Melanopic Lux Dashboard</div>
    <div id="controls">
      <label for="date-select">Select Date:</label>
      <select id="date-select"></select>

      <label for="resolution-select">Resolution:</label>
      <select id="resolution-select">
        <option value="5">Every 5 minutes</option>
        <option value="15">Every 15 minutes</option>
        <option value="60" selected>Hourly</option>
        <option value="360">Every 6 hours</option>
      </select>
    </div>
    <div id="chart-container">
      <div id="chart"></div>
      <div id="error-msg"></div>
    </div>
  </div>

  <script>
    const dragElement = (element, header) => {
      let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
      header.onmousedown = dragMouseDown;
      function dragMouseDown(e) {
        e.preventDefault();
        pos3 = e.clientX;
        pos4 = e.clientY;
        document.onmouseup = closeDragElement;
        document.onmousemove = elementDrag;
      }
      function elementDrag(e) {
        e.preventDefault();
        pos1 = pos3 - e.clientX;
        pos2 = pos4 - e.clientY;
        pos3 = e.clientX;
        pos4 = e.clientY;
        element.style.top = (element.offsetTop - pos2) + "px";
        element.style.left = (element.offsetLeft - pos1) + "px";
      }
      function closeDragElement() {
        document.onmouseup = null;
        document.onmousemove = null;
      }
    };
    dragElement(document.getElementById("dashboard-window"), document.getElementById("dashboard-header"));

    const baseUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTABn-Pt-pNX6oVoBvNtwVy7WLIbNr2KgT8eV75QBJrsatAqwi56Y3PqD7h9mdF7kGPNMHrKmJGVcag/pub?gid=0&single=true&output=csv";
    const csvUrl = baseUrl + "&cb=" + Date.now();
    let parsedData = [];

    function groupByResolution(data, resolutionMinutes) {
      const grouped = {};
      data.forEach(row => {
        const date = row.dateStr;
        const datetime = row.datetime;
        const timeKey = new Date(Math.floor(datetime.getTime() / (resolutionMinutes * 60 * 1000)) * resolutionMinutes * 60 * 1000);
        const key = date + " " + timeKey.toTimeString().substring(0,5);
        if (!grouped[key]) {
          grouped[key] = { time: timeKey, date: date, mel: 0, count: 0 };
        }
        grouped[key].mel += row.mel;
        grouped[key].count += 1;
      });
      return Object.values(grouped).map(g => {
        return { time: g.time, date: g.date, mel: g.mel / g.count };
      });
    }

    function updateChart(date, resolution) {
      const resolutionMinutes = parseInt(resolution);
      const groupedData = groupByResolution(parsedData, resolutionMinutes);
      const dayData = groupedData.filter(d => d.date === date)
        .sort((a, b) => new Date(a.time) - new Date(b.time));
    
      const trace1 = {
        x: dayData.map(d => d.time),
        y: dayData.map(d => d.mel),
        mode: 'lines+markers',
        type: 'scatter',
        name: 'Melanopic Lux (Zoomed)',
        yaxis: 'y1',
        line: { color: '#FAAB36' },
        marker: { color: '#FAAB36' }
      };
    
      const trace2 = {
        x: dayData.map(d => d.time),
        y: dayData.map(d => d.mel),
        mode: 'lines+markers',
        type: 'scatter',
        name: 'Melanopic Lux (Full)',
        yaxis: 'y2',
        line: { color: '#FAAB36' },
        marker: { color: '#FAAB36' }
      };

      // Shared x-values and hover text for both traces
      const idealX = [
        new Date(`${date}T00:00:00`), new Date(`${date}T06:00:00`),
        new Date(`${date}T06:00:00`), new Date(`${date}T18:00:00`),
        new Date(`${date}T18:00:00`), new Date(`${date}T23:59:59`)
      ];
      const idealY = [1, 1, 250, 250, 10, 10];
      const idealText = [
        "1 lux max (sleeping)", "1 lux max (sleeping)",
        "≥ 250 lux (daytime)", "≥ 250 lux (daytime)",
        "10 lux max (evening)", "10 lux max (evening)"
      ];
      
      const traceIdealZoomed = {
        x: idealX,
        y: idealY,
        mode: 'lines+text',
        name: 'Ideal (Zoomed)',
        line: { dash: 'dot', color: '#F78104', width: 2 },
        text: idealText,
        hoverinfo: 'text',
        textposition: 'top center',
        yaxis: 'y1'
      };
      
      const traceIdealFull = {
        x: idealX,
        y: idealY,
        mode: 'lines+text',
        name: 'Ideal (Full)',
        line: { dash: 'dot', color: '#F78104', width: 2 },
        text: idealText,
        hoverinfo: 'text',
        textposition: 'top center',
        yaxis: 'y2'
      };


      const layout = {
        title: `Melanopic Lux on ${date}`,
        grid: { rows: 2, columns: 1, pattern: 'independent', roworder: 'bottom to top' },
        paper_bgcolor: '#008083',
        plot_bgcolor: '#008083',
        font: { family: 'Helvetica Neue', size: 14, color: '#ffffff' },
        xaxis: {
          title: 'Time',
          domain: [0, 1],
          anchor: 'y2',
          gridcolor: '#e0e0e0',
          range: [
            new Date(date + "T00:00:00"),
            new Date(date + "T23:59:59")
          ]
        },
        yaxis: {
          title: '0–10 Lux (Zoomed)',
          range: [0, 10],
          domain: [0.75, 1],
          gridcolor: '#e0e0e0'
        },
        yaxis2: {
          title: '0–500 Lux (Full)',
          range: [0, 500],
          domain: [0, 0.75],
          gridcolor: '#e0e0e0'
        },
        legend: {
          orientation: 'h',
          y: -0.2
        }
      };
    
      Plotly.newPlot('chart', [trace1, trace2, traceIdealZoomed, traceIdealFull], layout, { scrollZoom: true, responsive: true });
    }

    function populateControls() {
      const dateSelect = document.getElementById('date-select');
      const resolutionSelect = document.getElementById('resolution-select');
      const uniqueDates = [...new Set(parsedData.map(row => row.dateStr))];
      if (uniqueDates.length === 0) {
        document.getElementById('error-msg').textContent = "No valid data found in the sheet.";
        return;
      }
      uniqueDates.forEach(date => {
        const opt = document.createElement('option');
        opt.value = date;
        opt.textContent = date;
        dateSelect.appendChild(opt);
      });
      dateSelect.value = uniqueDates[uniqueDates.length - 1];

      dateSelect.onchange = () => updateChart(dateSelect.value, resolutionSelect.value);
      resolutionSelect.onchange = () => updateChart(dateSelect.value, resolutionSelect.value);

      updateChart(dateSelect.value, resolutionSelect.value);
    }

    Papa.parse(csvUrl, {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: function(results) {

        parsedData = results.data.map(row => {
          const ts = parseInt((row['timestamp'] || '').trim());
          const mel = parseFloat((row['mel'] || '').trim());
          if (isNaN(ts) || isNaN(mel)) return null;
        
          const local = new Date(ts * 1000); // Uses browser's local timezone automatically
          const dateStr = local.toISOString().split('T')[0];
        
          return {
            datetime: local,
            dateStr: dateStr,
            mel: mel
          };
        }).filter(r => r !== null);
        
        populateControls();
      }
    });
  </script>
</body>
</html>
