
<!DOCTYPE html>
<html>
<head>
  <title>Live Melanopic Lux Dashboard (Cache-Busting Enabled)</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #005F60; /* deep teal */
      margin: 0;
      height: 100vh;
    }
    #dashboard-window {
      width: 800px;
      border: 1px solid #ccc;
      border-radius: 10px;
      position: absolute;
      top: 100px;
      left: 100px;
      background: #FAAB36;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      z-index: 1000;
    }
    #dashboard-header {
      padding: 10px;
      background-color: #FD5901; /* strong orange */
      color: white;
      cursor: move;
      font-weight: bold;
      border-top-left-radius: 10px;
      border-top-right-radius: 10px;
    }
    #controls {
      margin: 10px;
    }
    select {
      padding: 5px 10px;
      margin-right: 10px;
    }
    #chart-container {
      background: #ffffff;
      padding: 20px;
    }
    #error-msg {
      color: red;
      padding: 0 20px 20px 20px;
    }
    
    select {
      padding: 6px 12px;
      background-color: #FAAB36;  /* soft orange */
      border: 1px solid #F78104;  /* deeper orange border */
      border-radius: 5px;
      color: #000;                /* dark text for contrast */
      font-weight: bold;
    }
    
    select:hover {
      background-color: #F78104;  /* hover: deeper orange */
      cursor: pointer;
    }
    
    select:focus {
      outline: none;
      box-shadow: 0 0 0 2px rgba(253, 89, 1, 0.4); /* orange glow */
    }
    select {
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
    }
    #dashboard-window {
      transition: transform 0.2s ease;
    }
    #dashboard-window:active {
      transform: scale(1.01);
    }


  </style>
</head>
<body>
  <div id="dashboard-window">
    <div id="dashboard-header">Melanopic Lux Dashboard</div>
    <div id="controls">
      <label for="date-select">Select Date:</label>
      <select id="date-select"></select>

      <label for="resolution-select">Resolution:</label>
      <select id="resolution-select">
        <option value="5">Every 5 minutes</option>
        <option value="15">Every 15 minutes</option>
        <option value="60" selected>Hourly</option>
        <option value="360">Every 6 hours</option>
      </select>
    </div>
    <div id="chart-container">
      <div id="chart" style="width: 100%; height: 500px;"></div>
      <div id="error-msg"></div>
    </div>
  </div>

  <script>
    const dragElement = (element, header) => {
      let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
      header.onmousedown = dragMouseDown;
      function dragMouseDown(e) {
        e.preventDefault();
        pos3 = e.clientX;
        pos4 = e.clientY;
        document.onmouseup = closeDragElement;
        document.onmousemove = elementDrag;
      }
      function elementDrag(e) {
        e.preventDefault();
        pos1 = pos3 - e.clientX;
        pos2 = pos4 - e.clientY;
        pos3 = e.clientX;
        pos4 = e.clientY;
        element.style.top = (element.offsetTop - pos2) + "px";
        element.style.left = (element.offsetLeft - pos1) + "px";
      }
      function closeDragElement() {
        document.onmouseup = null;
        document.onmousemove = null;
      }
    };
    dragElement(document.getElementById("dashboard-window"), document.getElementById("dashboard-header"));

    const baseUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTABn-Pt-pNX6oVoBvNtwVy7WLIbNr2KgT8eV75QBJrsatAqwi56Y3PqD7h9mdF7kGPNMHrKmJGVcag/pub?gid=0&single=true&output=csv";
    const csvUrl = baseUrl + "&cb=" + Date.now();
    let parsedData = [];

    function groupByResolution(data, resolutionMinutes) {
      const grouped = {};
      data.forEach(row => {
        const date = row.dateStr;
        const datetime = row.datetime;
        const timeKey = new Date(Math.floor(datetime.getTime() / (resolutionMinutes * 60 * 1000)) * resolutionMinutes * 60 * 1000);
        const key = date + " " + timeKey.toTimeString().substring(0,5);
        if (!grouped[key]) {
          grouped[key] = { time: timeKey, date: date, mel: 0, count: 0 };
        }
        grouped[key].mel += row.mel;
        grouped[key].count += 1;
      });
      return Object.values(grouped).map(g => {
        return { time: g.time, date: g.date, mel: g.mel / g.count };
      });
    }

    function updateChart(date, resolution) {
      const resolutionMinutes = parseInt(resolution);
      const groupedData = groupByResolution(parsedData, resolutionMinutes);
      const dayData = groupedData.filter(d => d.date === date)
        .sort((a, b) => new Date(a.time) - new Date(b.time));

      const trace = {
        x: dayData.map(d => d.time),
        y: dayData.map(d => d.mel),
        mode: 'lines+markers',
        type: 'scatter',
        name: 'Melanopic Lux',
        line: { color: '#FAAB36' },  // yellow
        marker: { color: '#FAAB36' }
      };

      const layout = {
        title: `Melanopic Lux on ${date}`,
        paper_bgcolor: '#008083',
        plot_bgcolor: '#008083',
        font: { family: 'Helvetica Neue', size: 14, color: '#ffffff' },
        xaxis: {
          title: 'Time',
          gridcolor: '#e0e0e0',
          range: [
            new Date(date + "T00:00:00"),
            new Date(date + "T23:59:59")
          ]
        },
        yaxis: {
          title: 'Melanopic Lux',
          range: [0, 500],
          autorange: false,
          gridcolor: '#e0e0e0'
        }
      };

      Plotly.newPlot('chart', [trace], layout, { scrollZoom: true, responsive: true });
    }

    function populateControls() {
      const dateSelect = document.getElementById('date-select');
      const resolutionSelect = document.getElementById('resolution-select');
      const uniqueDates = [...new Set(parsedData.map(row => row.dateStr))];
      if (uniqueDates.length === 0) {
        document.getElementById('error-msg').textContent = "No valid data found in the sheet.";
        return;
      }
      uniqueDates.forEach(date => {
        const opt = document.createElement('option');
        opt.value = date;
        opt.textContent = date;
        dateSelect.appendChild(opt);
      });
      dateSelect.value = uniqueDates[uniqueDates.length - 1];

      dateSelect.onchange = () => updateChart(dateSelect.value, resolutionSelect.value);
      resolutionSelect.onchange = () => updateChart(dateSelect.value, resolutionSelect.value);

      updateChart(dateSelect.value, resolutionSelect.value);
    }

    Papa.parse(csvUrl, {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: function(results) {
        parsedData = results.data.map(row => {
          const ts = parseInt((row['timestamp'] || '').trim());
          const mel = parseFloat((row['mel'] || '').trim());
          if (isNaN(ts) || isNaN(mel)) return null;

          const utc = new Date(ts * 1000);
          const est = new Date(utc.getTime() - (5 * 60 * 60 * 1000));
          const dateStr = est.toISOString().split('T')[0];

          return {
            datetime: est,
            dateStr: dateStr,
            mel: mel
          };
        }).filter(r => r !== null);

        populateControls();
      }
    });
  </script>
</body>
</html>
